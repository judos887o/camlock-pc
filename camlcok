--// CAMLOCK CLEAN //--

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera

local fovRadius   = 1200
local smoothness  = 0.18
local maxPrediction = 0.2

local isAiming = false
local targetCharacter = nil

local function getClosestTarget()
    local closestTarget = nil
    local shortestDistance = fovRadius

    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= localPlayer and plr.Character then
            local hum = plr.Character:FindFirstChildOfClass("Humanoid")
            local head = plr.Character:FindFirstChild("Head")
            if hum and hum.Health > 0 and head then
                local screenPos, onScreen = camera:WorldToViewportPoint(head.Position)
                if onScreen then
                    local dist = (Vector2.new(screenPos.X, screenPos.Y) -
                                  Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)).Magnitude
                    if dist < shortestDistance then
                        shortestDistance = dist
                        closestTarget = plr.Character
                    end
                end
            end
        end
    end

    return closestTarget
end

local function getAverageHitboxPosition(char)
    local points = {}
    for _, name in ipairs({"Head", "UpperTorso", "HumanoidRootPart"}) do
        local p = char:FindFirstChild(name)
        if p then table.insert(points, p.Position) end
    end
    if #points == 0 then return nil end
    local sum = Vector3.new(0,0,0)
    for _, pos in ipairs(points) do sum += pos end
    return sum / #points
end

local function getPredictedPosition(char)
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    local avgPos = getAverageHitboxPosition(char)
    if not avgPos then return nil end

    local vel   = hrp.Velocity
    local speed = vel.Magnitude
    local dynPred = math.clamp(speed / 50, 0, maxPrediction)

    return avgPos + vel * dynPred
end

-- Q toggelt Camlock
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.Q then
        if isAiming then
            isAiming = false
            targetCharacter = nil
        else
            local t = getClosestTarget()
            if t then
                isAiming = true
                targetCharacter = t
            end
        end
    end
end)

RunService.RenderStepped:Connect(function()
    if isAiming and targetCharacter then
        local hum = targetCharacter:FindFirstChildOfClass("Humanoid")
        if not hum or hum.Health <= 0 then
            isAiming = false
            targetCharacter = nil
            return
        end

        local predicted = getPredictedPosition(targetCharacter)
        if predicted then
            local curCF = camera.CFrame
            local newCF = CFrame.new(curCF.Position, predicted)
            camera.CFrame = curCF:Lerp(newCF, smoothness)
        end
    end
end)
